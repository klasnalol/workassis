function getCSRFToken(){return $("meta[name=\"csrf-token\"]").attr("content")}$.ajaxSetup({beforeSend:function(a,b){"POST"===b.type&&a.setRequestHeader("X-CSRFToken",getCSRFToken())}});const socket=io();$("#send-text-btn").click(()=>{const a=$("#user-input").val().trim();a&&($("#user-input").val(""),appendMessageToChatBox("user",a,new Date().toLocaleTimeString()),showBotThinking(),socket.emit("send_text_message",{message:a}))}),socket.on("receive_message",a=>{const{role:b,content:c,timestamp:d,voice_url:e}=a;if("error"===b)return alert(c),void hideBotThinking();if("bot"===b&&(replaceBotThinking(b,c,d),e)){const a=new Audio(e);a.play()}});function appendMessageToChatBox(a,b,c){const d=$("#chat-box"),e=`<div class="d-flex ${"user"===a?"justify-content-end":"justify-content-start"} mb-2"><div class="chat-bubble p-2 ${"user"===a?"bg-primary text-white":"bg-light text-dark"}" style="border-radius: 10px; max-width: 70%;"><small><strong>${a.charAt(0).toUpperCase()+a.slice(1)}</strong></small><br><p class="mb-1">${b}</p><small class="text-muted">${c}</small></div></div>`;d.append(e),d.scrollTop(d[0].scrollHeight)}function showBotThinking(){$("#bot-thinking").removeClass("d-none");const a=$("#chat-box");a.scrollTop(a[0].scrollHeight)}function hideBotThinking(){$("#bot-thinking").addClass("d-none")}function replaceBotThinking(a,b,c){hideBotThinking(),appendMessageToChatBox(a,b,c)}$(document).ready(()=>{populateMicrophones()});async function populateMicrophones(){try{await navigator.mediaDevices.getUserMedia({audio:!0});const a=await navigator.mediaDevices.enumerateDevices(),b=a.filter(a=>"audioinput"===a.kind),c=$("#mic-select-chat");c.empty(),b.forEach((a,b)=>{const d=`<option value="${a.deviceId}">${a.label||"Microphone "+(b+1)}</option>`;c.append(d)}),0===b.length?(c.append("<option value=\"\">No microphone available</option>"),$("#record-voice-btn").prop("disabled",!0)):$("#record-voice-btn").prop("disabled",!1)}catch(a){console.error("Error fetching microphones:",a),$("#mic-select-chat").html("<option value=\"\">No microphone available</option>"),$("#record-voice-btn").prop("disabled",!0),alert("Could not access microphones. Check your browser settings and permissions.")}}let mediaRecorderVoice,recordedChunksVoice=[];$("#record-voice-btn").click(async()=>{recordedChunksVoice=[];const a=$("#mic-select-chat").val();if(!a)return void alert("No microphone selected or available.");try{const b=await navigator.mediaDevices.getUserMedia({audio:{deviceId:{exact:a}}});mediaRecorderVoice=new MediaRecorder(b),mediaRecorderVoice.ondataavailable=a=>{0<a.data.size&&recordedChunksVoice.push(a.data)},mediaRecorderVoice.onstop=()=>{const a=new Blob(recordedChunksVoice,{type:"audio/webm"}),b=new FormData;b.append("audio_file",a,"voice_input.webm"),showBotThinking(),$.ajax({url:"/chat_voice",type:"POST",data:b,processData:!1,contentType:!1,success:function(a){if(a.error)alert("Error: "+a.error),hideBotThinking();else{const{user_message:b,bot_message:c,bot_voice_url:d}=a,e=new Date().toLocaleTimeString();if(appendMessageToChatBox("user",b,e),appendMessageToChatBox("bot",c,e),d){const a=new Audio(d);a.play()}hideBotThinking()}},error:function(a){console.error("Error submitting voice message:",a),alert("Error submitting voice message. Please try again."),hideBotThinking()}})},mediaRecorderVoice.start(),showRecordingAnimation(),$("#record-voice-btn").prop("disabled",!0),$("#stop-record-voice-btn").prop("disabled",!1).removeClass("d-none"),setTimeout(()=>{mediaRecorderVoice&&"inactive"!==mediaRecorderVoice.state&&(mediaRecorderVoice.stop(),hideRecordingAnimation(),$("#record-voice-btn").prop("disabled",!1),$("#stop-record-voice-btn").prop("disabled",!0).addClass("d-none"))},5e3)}catch(a){console.error("Error accessing microphone:",a),alert("Could not access the microphone. Check permissions and try again.")}}),$("#stop-record-voice-btn").click(()=>{mediaRecorderVoice&&"inactive"!==mediaRecorderVoice.state&&(mediaRecorderVoice.stop(),hideRecordingAnimation(),$("#record-voice-btn").prop("disabled",!1),$("#stop-record-voice-btn").prop("disabled",!0).addClass("d-none"))});function showRecordingAnimation(){$("#recording-animation").removeClass("d-none")}function hideRecordingAnimation(){$("#recording-animation").addClass("d-none")}$("#user-input").keypress(a=>{13!==a.which||a.shiftKey||(a.preventDefault(),$("#send-text-btn").click())});