const openSearchBtn=document.getElementById("open-search-sidebar"),closeSearchBtn=document.getElementById("close-search-sidebar"),searchSidebar=document.getElementById("search-sidebar");openSearchBtn.addEventListener("click",()=>{searchSidebar.classList.add("open")}),closeSearchBtn.addEventListener("click",()=>{searchSidebar.classList.remove("open")});let page=2,isLoading=!1;window.addEventListener("scroll",()=>{window.innerHeight+window.scrollY>=document.body.offsetHeight-100&&!isLoading&&loadMoreProducts()});async function loadMoreProducts(){try{isLoading=!0;const a=await fetch(`/load_more_products?page=${page}`);if(!a.ok)throw new Error("Failed to fetch products.");const b=await a.json();if(0===b.length)return;const c=document.getElementById("products-container");b.forEach(a=>{const b=document.createElement("div");b.className="product-item",b.innerHTML=`<div class="product-image"><img src="${a.image_url}" alt="${a.name}" /></div><button class="details-toggle" onclick="toggleDetails(this)">{{ translations['more_info'] }}</button><div class="product-details"><button type="button" class="less-info-btn" onclick="closeDetails(this)">{{ translations['less_info'] }}</button><h3>${a.name}</h3><p>${a.description}</p><p>Price: $${a.price}</p><p>Category: ${a.category}</p></div>`,c.appendChild(b)}),page+=1}catch(a){console.error("Error loading products:",a)}finally{isLoading=!1}}function toggleDetails(a){const b=a.nextElementSibling,c=b.classList.toggle("open");a.textContent=c?"Less Info":"More Info"}function closeDetails(a){const b=a.closest(".product-details"),c=b.closest(".product-item"),d=c.querySelector(".details-toggle");b.classList.remove("open"),d.textContent="More Info"}document.addEventListener("DOMContentLoaded",()=>{function a(){f=!f;const a=document.querySelectorAll(".keyboard-key:not(.special-key)");a.forEach(a=>{"Space"!==a.textContent&&(a.textContent=f?a.textContent.toUpperCase():a.textContent.toLowerCase())})}const b=document.getElementById("keyboard-container"),c=document.getElementById("keyboard"),d=document.getElementById("query-input"),e=document.getElementById("submit-search");let f=!1;[["q","w","e","r","t","y","u","i","o","p"],["a","s","d","f","g","h","j","k","l"],["\u21E7","z","x","c","v","b","n","m","\u232B"],["Space","Enter"]].forEach(b=>{const g=document.createElement("div");g.className="keyboard-row",b.forEach(b=>{const c=document.createElement("button");c.type="button",c.textContent="Space"===b?"Space":b,c.className=`keyboard-key ${["\u232B","\u21E7","Space","Enter"].includes(b)?"special-key":""}`,"\u232B"===b?c.onclick=()=>{d.value=d.value.slice(0,-1)}:"\u21E7"===b?c.onclick=()=>a():"Space"===b?(c.onclick=()=>{d.value+=" "},c.classList.add("space-bar")):"Enter"===b?c.onclick=()=>{""!==d.value.trim()&&e.click()}:c.onclick=()=>{d.value+=f?b.toUpperCase():b.toLowerCase()},g.appendChild(c)}),c.appendChild(g)}),document.getElementById("keyboard-btn").addEventListener("click",()=>{b.style.display="flex"}),window.closeKeyboard=()=>{b.style.display="none"}});let mediaRecorderVoice,mediaRecorderReturn,recordedChunksVoice=[],recordedChunksReturn=[];const micSelectVoice=document.getElementById("mic-select-voice"),micSelectReturn=document.getElementById("mic-select-return"),startBtnVoice=document.getElementById("start-record-btn-voice"),stopBtnVoice=document.getElementById("stop-record-btn-voice"),startBtnReturn=document.getElementById("start-record-btn-return"),stopBtnReturn=document.getElementById("stop-record-btn-return"),formVoice=document.getElementById("voice-input-form"),formReturn=document.getElementById("return-product-form"),floatingMicBtn=document.getElementById("floating-mic-btn");async function populateMicrophones(){const a=await navigator.mediaDevices.enumerateDevices(),b=a.filter(a=>"audioinput"===a.kind);micSelectVoice.innerHTML="",micSelectReturn.innerHTML="",b.forEach((a,b)=>{const c=document.createElement("option");c.value=a.deviceId,c.textContent=a.label||`Microphone ${b+1}`,micSelectVoice.appendChild(c);const d=document.createElement("option");d.value=a.deviceId,d.textContent=a.label||`Microphone ${b+1}`,micSelectReturn.appendChild(d)})}populateMicrophones(),startBtnVoice.addEventListener("click",async()=>{recordedChunksVoice=[];const a=micSelectVoice.value,b=await navigator.mediaDevices.getUserMedia({audio:{deviceId:a?{exact:a}:void 0}});mediaRecorderVoice=new MediaRecorder(b),mediaRecorderVoice.ondataavailable=a=>{recordedChunksVoice.push(a.data)},mediaRecorderVoice.onstop=async()=>{const a=new Blob(recordedChunksVoice,{type:"audio/webm"}),b=new FormData(formVoice);b.append("audio_file",a,"voice_input.webm");try{const a=await fetch(formVoice.action,{method:"POST",body:b});if(a.ok){const b=await a.text();document.open(),document.write(b),document.close()}else console.error("Failed to submit audio."),alert("Failed to submit audio. Please try again.")}catch(a){console.error("Error submitting audio:",a),alert("Error submitting audio. Please try again.")}},mediaRecorderVoice.start(),startBtnVoice.disabled=!0,stopBtnVoice.disabled=!1,setTimeout(()=>{mediaRecorderVoice&&"inactive"!==mediaRecorderVoice.state&&(mediaRecorderVoice.stop(),startBtnVoice.disabled=!1,stopBtnVoice.disabled=!0)},5e3)}),stopBtnVoice.addEventListener("click",()=>{mediaRecorderVoice&&"inactive"!==mediaRecorderVoice.state&&(mediaRecorderVoice.stop(),startBtnVoice.disabled=!1,stopBtnVoice.disabled=!0)}),startBtnReturn.addEventListener("click",async()=>{recordedChunksReturn=[];const a=micSelectReturn.value,b=await navigator.mediaDevices.getUserMedia({audio:{deviceId:a?{exact:a}:void 0}});mediaRecorderReturn=new MediaRecorder(b),mediaRecorderReturn.ondataavailable=a=>{recordedChunksReturn.push(a.data)},mediaRecorderReturn.onstop=async()=>{const a=new Blob(recordedChunksReturn,{type:"audio/webm"}),b=new FormData(formReturn);b.append("audio_file",a,"voice_input.webm");try{const a=await fetch(formReturn.action,{method:"POST",body:b});if(a.ok){const b=await a.text();document.open(),document.write(b),document.close()}else console.error("Failed to submit audio.")}catch(a){console.error("Error submitting audio:",a),alert("Error submitting audio. Please try again.")}hideRecordingAnimation()},showRecordingAnimation(),mediaRecorderReturn.start(),startBtnReturn.disabled=!0,stopBtnReturn.disabled=!1,setTimeout(()=>{mediaRecorderReturn&&"inactive"!==mediaRecorderReturn.state&&(mediaRecorderReturn.stop(),startBtnReturn.disabled=!1,stopBtnReturn.disabled=!0)},5e3)}),stopBtnReturn.addEventListener("click",()=>{mediaRecorderReturn&&"inactive"!==mediaRecorderReturn.state&&(mediaRecorderReturn.stop(),startBtnReturn.disabled=!1,stopBtnReturn.disabled=!0)});function showRecordingAnimation(){$("#recording-animation").removeClass("d-none")}function hideRecordingAnimation(){$("#recording-animation").addClass("d-none")}