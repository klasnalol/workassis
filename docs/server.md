## Предисловие
Пока у меня скачивается ollama _(90 Кбайт/с, спасибо К-телеком!)_, пишу текущую инфраструктуру сервера. По идее, тут не нужна информация о железе, ибо так должна работать инфраструктра, разделяя железо и разработчиков тонкой линией абстракции, но увы у нас как всегда - всё из говна и палок!

## Функционал
<sub>(Аля, ***что*** он *должен* делать)</sub>

Пока наш текущий сервер выполняет несколько функций:

  - SSH-сервер. Так мы можем дистанционно подключится к нему и управлять. __Учись пользроваться SSH, Алан !__
  - Web-сервер. Думаю очевидно, так пользователи получают сайт по кускам.
  - База данных. По идее не совсем, но тут хранится наша бд. Об этом позже
  - Ollama-хост. Сама по себе ollama работает как HTTP-сервер, где сервер как раз занимается всем ИИ-приколами, а клиент HTTP-запросами общается с ним.
 

## Описание:

<sub>(Это, скорее, ***что*** **есть** он)</sub> 

<sub><sub>(Бля, такими оборотами в русском уже давно не пользуются)</sub></sub>

ОС: [NixOS](https://nixos.org/), пока версия 24.11. Это дистрибутив Linux, но по работе это не типичный дистрибутив! Алан, Хаджик учитесь пользоваться!

<sup>(Почти)</sup> Все настройки производятся через конфигурационные файлы *nix*. 

Это удобно тем, что ты говоришь системе, какой она должна быть, а как она делает себя такой тебя не ебёт, так называемая декларативная конфигурация (_"declarative configuration"_). Легко воссоздать рабочее окружение.

Это неудобно тем, что нужно учить новый язык программирования. \
Ну по факту, язык выражений. Что-то между настоящих языков программирования и JSON. Скорее JSON на стеоройдах. Ну ещё тут все делается через nix, если идешь по пути обычных дистрибутивов и против парадигм nix, то тебе ой как не весело будет. Ах да, документации мало пиздец. Удачи!

## Строение:

Ну это самый сок и то, что вам должно быть больше всего интересно.

Работает это так:

  - `sshd`(от OpenSSH) и `nginx` работают отдельно и параллельно, запускаются на старте. Их статус можно посмотреть через `systemctl status [НАЗВАНИЕ КОНТЕЙНЕРА]`
  - Наш сайт запускается в docker контейнере. Саму инфорамцию о образе контейнера можете посмотреть в Dockerfile. Построить образ можно так: `docker build -t [НАЗВАНИЕ ОБРАЗА]:[ТЕГ ОБРАЗА]` с корневой папки проекта. Запустить контейнер можно так: `docker run --name [НАЗВАНИЕ КОНТЕЙНЕРА] [РЕЖИМ] -p [МАП ПОРТОВ] [НАЗВАНИЕ ОБРАЗА]:[ТЕГ ОБРАЗА]` Выглядит устрашающе, но тут просто! 
    - И `[НАЗВАНИЕ ОБРАЗА]`, и `[НАЗВАНИЕ КОНТЕЙНЕРА]` могут быть чем угодно в разумных границах. Главное, чтобы название контейнера не совпадало с уже запущенным контейнером. Для тестов рекомендую останавливать контейнер и пересобирать его. Так хотя бы разные итерации контейнеров не занимают много места.
    - `[РЕЖИМ]` - это тот режим в котором запускается контейнер. Его можно запустить интерактивно, `РЕЖИМ=-it`, (это дефолт вроде), как обычную CLI-программу, можно запустить на заднем фоне как демона,`РЕЖИМ=-d`. Есть еще пару режимов, можете почитать, но обычно так: `-it` во время ручных тестов, `-d` когда запускаешь на сервере
    - `[МАП ПОРТОВ]` - это то, как переводятся порты с контейнера на хост. Наш сайт сейчас использует порты 80/443 (для HTTP и HTTPS соотвественно), но наша прога слушает на порту 5002. Как так? Port mapping. По факту, писать при запуске не обязательно, если порты прописаны в Dockerfile. Но я параноик и так дебаггать проще на самом сервере. Можете пропустить.
    - Не забудьте добавить .env файл, где будет API-ключ Хаджика для OpenAI Whisper. Думаю ~~Надеюсь~~, скоро от него избавимся.
    - Если что ещё интересно, можете [здесь](https://docs.docker.com/reference/dockerfile/) почитать. Docker - это круто. Docker - это база.
  - Ollama сейчас не поставлена, но по идее это просто HTTP-сервер, слушающий (по дефолту) на порте 11434
 
Сама структура такая:
  - SSH-сервер слушает на портах 22 (только в локальной сети... почему-то) и 2222 (и в локальной, и в глобальной). Вход по ключам, поэтому сделайте их и дайте админам сервера. Как это делать можно посмотреть [здесь](https://docs.github.com/en/authentication/connecting-to-github-with-ssh/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent). Конфигурация тут: `/etc/nixos/configuration.nix`
  - HTTP-запросы принимает nginx, который потом перекидывает их куда нужно (то есть, является обратым прокси/reverse proxy). Пока ток на localhost:5002, аля на нашу прогу (может дадим ей название?). Его конфигурацию менять нужно в `/etc/nixos/nginx.nix`, если не перенесём куда-то ещё.
