{% extends 'base.html' %}

{% block title %}Home - Product Query App{% endblock %}

{% block content %}

<section>
    <h2>Admin Panel</h2>
    {% if 'user_id' in session and session['role'] == 'admin' %}
        <a href="{{ url_for('admin_panel') }}">Go to Admin Panel</a>
    {% endif %}
</section>
{% if 'user_id' in session and session['role'] == 'admin' %}
<section>
    <h2>Add a New Product</h2>
    <a href="{{ url_for('add_product') }}">Add a Product</a>
</section>
{% endif %}
<section class="query-section">
    <div class="voice-query">
        <h2>Submit a Voice Query</h2>
        <form action="/voice_input" method="post">
            <button type="submit">Record Voice Query (5 seconds)</button>
        </form>
        <form action="/return_product" method="post">
            <label for="language">Select Language:</label>
            <select id="language" name="language">
                <option value="ru">Русский</option>
                <option value="kz">Қазақша</option>
                <option value="en">English</option>
            </select>
            <button type="submit">Return product (5 seconds)</button>
        </form>
    </div>

    <div class="search-query">
        <h2>Search Products</h2>
        <form id="search-form" action="/search" method="get">
            <label for="query-input"></label><input type="text" id="query-input" name="query" placeholder="Search products..." required>
            <button type="button" id="keyboard-btn">Open Keyboard</button>
            <div id="keyboard-container" class="onscreen-keyboard" style="display: none;">
                <!-- Remove inline style from the button -->
                <button type="button" id="close-keyboard" onclick="closeKeyboard()">X</button>
                <div id="keyboard">
                    <!-- Keys will be dynamically generated -->
                </div>
            </div>
            <label>
                <select name="category">
                    <option value="">All Categories</option>
                    <option value="electronics">Electronics</option>
                    <option value="fashion">Fashion</option>
                    <option value="home">Home</option>
                </select>
            </label>
            <label>
                <select name="price_range">
                    <option value="">All Prices</option>
                    <option value="low">Under $50</option>
                    <option value="medium">$50 - $200</option>
                    <option value="high">Above $200</option>
                </select>
            </label>
            <button type="submit" id="submit-search">Search</button>
        </form>
    </div>
</section>

<section id="product-list">
    <h2>Product List</h2>
    <div id="products-container" class="products-grid">
        {% for product in products %}
            <div class="product-item">
                <div class="product-image">
                    <img src="{{ product.image_url }}" alt="{{ product.name }}" />
                </div>
                <button class="details-toggle" onclick="toggleDetails(this)">More Info</button>
                <div class="product-details" style="display: none;">
                    <h3>{{ product.name }}</h3>
                    <p>{{ product.description }}</p>
                    <p>Price: ${{ product.price }}</p>
                    <p>Category: {{ product.category }}</p>
                </div>
            </div>
        {% else %}
            <p>No products available.</p>
        {% endfor %}
    </div>
</section>

<script>
    // Event listener to save selected language
    document.getElementById('language').addEventListener('change', function () {
        const selectedLanguage = this.value;
        // Store the selected language in localStorage
        localStorage.setItem('selectedLanguage', selectedLanguage);
    });

    // On page load, set the dropdown to the saved language
    document.addEventListener('DOMContentLoaded', function () {
        const savedLanguage = localStorage.getItem('selectedLanguage');
        if (savedLanguage) {
            document.getElementById('language').value = savedLanguage;
        }
    });

    // Function to attach the selected language to forms before submission
    function attachLanguageToForms() {
        const language = localStorage.getItem('selectedLanguage') || 'en';
        // Append a hidden input for language to each form
        document.querySelectorAll('form').forEach(form => {
            if (!form.querySelector('input[name="language"]')) {
                const languageInput = document.createElement('input');
                languageInput.type = 'hidden';
                languageInput.name = 'language';
                languageInput.value = language;
                form.appendChild(languageInput);
            }
        });
    }

    // Attach language to forms on submission
    document.querySelectorAll('form').forEach(form => {
        form.addEventListener('submit', attachLanguageToForms);
    });


    let page = 2; // Start from page 2 since page 1 is already loaded
    let isLoading = false;
    let isUppercase = false;

    // Infinite scrolling
    window.addEventListener('scroll', () => {
        if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 100 && !isLoading) {
            loadMoreProducts();
        }
    });

    async function loadMoreProducts() {
        try {
            isLoading = true;
            const response = await fetch(`/load_more_products?page=${page}`);
            if (!response.ok) throw new Error('Failed to fetch products.');

            const products = await response.json();
            const container = document.getElementById('products-container');

            if (products.length === 0) return;

            products.forEach(product => {
                const productDiv = document.createElement('div');
                productDiv.className = 'product-item';
                productDiv.innerHTML = `
                    <div class="product-image">
                        <img src="${product.image_url}" alt="${product.name}" />
                    </div>
                    <button class="details-toggle" onclick="toggleDetails(this)">More Info</button>
                    <div class="product-details" style="display: none;">
                        <h3>${product.name}</h3>
                        <p>${product.description}</p>
                        <p>Price: $${product.price}</p>
                        <p>Category: ${product.category}</p>
                    </div>
                `;
                container.appendChild(productDiv);
            });

            page += 1;
        } catch (error) {
            console.error('Error loading products:', error);
        } finally {
            isLoading = false;
        }
    }

    function toggleDetails(button) {
        const details = button.nextElementSibling;
        details.style.display = details.style.display === 'none' ? 'block' : 'none';
        button.textContent = details.style.display === 'block' ? 'Less Info' : 'More Info';
    }

    // Onscreen keyboard logic
    document.addEventListener('DOMContentLoaded', () => {
        const keyboardContainer = document.getElementById('keyboard-container');
        const keyboard = document.getElementById('keyboard');
        const inputField = document.getElementById('query-input');
        const submitSearch = document.getElementById('submit-search');

        const rows = [
            ['q', 'w', 'e', 'r', 't', 'y', 'u', 'i', 'o', 'p'],
            ['a', 's', 'd', 'f', 'g', 'h', 'j', 'k', 'l'],
            ['⇧', 'z', 'x', 'c', 'v', 'b', 'n', 'm', '⌫'],
            ['Space', 'Enter'],
        ];

        // Generate keyboard rows
        rows.forEach((row) => {
            const rowDiv = document.createElement('div');
            rowDiv.className = 'keyboard-row';

            row.forEach(char => {
                const key = document.createElement('button');
                key.type = 'button'; // Prevent form submission
                key.textContent = char === 'Space' ? 'Space' : char;
                key.className = `keyboard-key ${['⌫', '⇧', 'Space', 'Enter'].includes(char) ? 'special-key' : ''}`;

                if (char === '⌫') {
                    key.onclick = () => {
                        inputField.value = inputField.value.slice(0, -1); // Backspace
                    };
                } else if (char === '⇧') {
                    key.onclick = () => toggleUppercase();
                } else if (char === 'Space') {
                    key.onclick = () => {
                        inputField.value += ' '; // Add space
                    };
                    key.classList.add('space-bar');
                } else if (char === 'Enter') {
                    key.onclick = () => {
                        if (inputField.value.trim() !== '') {
                            submitSearch.click(); // Trigger search
                        }
                    };
                } else {
                    key.onclick = () => {
                        inputField.value += isUppercase ? char.toUpperCase() : char.toLowerCase(); // Add character
                    };
                }
                rowDiv.appendChild(key);
            });

            keyboard.appendChild(rowDiv);
        });

        // Show keyboard
        document.getElementById('keyboard-btn').addEventListener('click', () => {
            keyboardContainer.style.display = 'flex';
        });

        // Close keyboard
        window.closeKeyboard = () => {
            keyboardContainer.style.display = 'none';
        };

        function toggleUppercase() {
            isUppercase = !isUppercase;
            const keys = document.querySelectorAll('.keyboard-key:not(.special-key)');
            keys.forEach(key => {
                key.textContent = isUppercase
                    ? key.textContent.toUpperCase()
                    : key.textContent.toLowerCase();
            });
        }
    });
</script>

{% endblock %}
